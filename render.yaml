services:
  - name: aeroespacial-site-service
    type: web
    env:
      - key: AMBIENTE
        value: dev
      - key: APP_SESSION_URL
        value: redis://aeroespacial-redis-service:6379/0
      - key: APP_BROKER_URL
        value: redis://aeroespacial-redis-service:6379/1
      - key: APP_BACKEND_URL
        value: redis://aeroespacial-redis-service:6379/1
      - key: APP_CACHE_URL
        value: redis://aeroespacial-redis-service:6379/2
    buildCommand: ./docker/app.dockerfile
    healthCheckPath: /

  - name: aeroespacial-worker-service
    type: background
    env:
      - key: AMBIENTE
        value: dev
      - key: APP_BROKER_URL
        value: redis://aeroespacial-redis-service:6379/1
      - key: APP_BACKEND_URL
        value: redis://aeroespacial-redis-service:6379/1
      - key: APP_CACHE_URL
        value: redis://aeroespacial-redis-service:6379/2
    buildCommand: ./docker/app.dockerfile
    healthCheckPath: /

  - name: aeroespacial-nginx-service
    type: web
    env:
      - key: NGINX_WORKERS
        value: "2"
      - key: NGINX_ACCEPT_MUTEX
        value: on
      - key: NGINX_SERVER_APP
        value: aeroespacial-site-service:5000
      - key: NGINX_ACCESS_LOG
        value: off
      - key: NGINX_STATIC_FOLDER
        value: /usr/share/nginx/html/static
      - key: NGINX_TIMEOUT
        value: "300"
    buildCommand: ./docker/nginx.dockerfile
    healthCheckPath: /
    ports:
      - 80:80

  - name: aeroespacial-redis-service
    type: service
    image: redis:7.2.0-alpine3.18

volumes:
  - name: aeroespacial-static-volume

networks:
  - name: aeroespacial-network
    external: false

web:
  name: aeroespacial-web
  routes:
    - type: rewrite
      source: /
      destination: aeroespacial-nginx-service:80
